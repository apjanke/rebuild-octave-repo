# HG changeset patch
# User Thorsten Meyer <thorsten.meyier@gmx.de>
# Date 1235457997 18000
#      Tue Feb 24 01:46:37 2009 -0500
# Node ID 538184c540a9aff2267d64ceae949f80aeb56899
# Parent  8b7e448d989cf018bbbf8e115f6201dd45aa8eb0
Add make target "configfiles" to automatically regenerate configuration files

diff --git a/ChangeLog b/ChangeLog
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,10 +1,21 @@
+2009-02-24  John W. Eaton  <jwe@octave.org>
+
+	* configure.in: Copy Makefile to build directory if not building
+	in srcdir.
+
 2009-02-24  Thorsten Meyer  <thorsten@hexe>
 
+	* configure.in: AC_SUBST ac_config_files.
+	* Makeconf.in (config_opts): Define CONFIG_SUBDIRS variable.
+	* Makefile: Add make target for configuration files.
+	* octMakefile.in: Add make targets for configuration files,
+	config.status and configure.
+
 	* Makefile.in: Rename to Makefile.
 	* configure.in: Remove Makefile from list of autogenerated
 	configuration files.
 	* octMakefile.in: Remove references to Makefile.in, add Makefile
 	to list of CONF_DISTFILES.
 	* octMakefile.in (maintainer-clean distclean): Don't delete Makefile.
 
 2009-02-17  Benjamin Lindner  <lindnerb@users.sourceforge.net>
diff --git a/Makeconf.in b/Makeconf.in
--- a/Makeconf.in
+++ b/Makeconf.in
@@ -255,16 +255,18 @@ USE_64_BIT_IDX_T = @USE_64_BIT_IDX_T@
 TEXINFO_COLAMD = @TEXINFO_COLAMD@
 TEXINFO_CHOLMOD = @TEXINFO_CHOLMOD@
 TEXINFO_UMFPACK = @TEXINFO_UMFPACK@
 TEXINFO_QHULL = @TEXINFO_QHULL@
 
 # The arguments passed to configure.
 config_opts = @config_opts@
 
+CONFIG_SUBDIRS = @subdirs@
+
 # ==================== Where To Install Things ====================
 
 # The default location for installation.  Everything is placed in
 # subdirectories of this directory.  The default values for many of
 # the variables below are expressed in terms of this one, so you may
 # not need to change them.  This defaults to /usr/local.
 prefix = @prefix@
 
diff --git a/Makefile b/Makefile
--- a/Makefile
+++ b/Makefile
@@ -25,16 +25,19 @@ TARGETS = octave-bug octave-config mkoct
 	tags TAGS dist conf-dist snapshot snapshot-version \
 	.gdbinit run-octave
 
 NO_DEP_TARGETS = clean mostlyclean distclean maintainer-clean
 
 all: header-msg config-check
 	$(MAKE) -f octMakefile all
 
+configfiles: FORCE
+	$(MAKE) -f octMakefile configfiles
+
 $(TARGETS): FORCE
 	$(MAKE) -f octMakefile $@
 
 $(NO_DEP_TARGETS): FORCE
 	$(MAKE) -f octMakefile omit_deps=true $@
 
 # Maybe this message will prevent people from asking why the
 # Makefiles don't work for them.  Maybe not.
@@ -98,16 +101,18 @@ help: header-msg
 	@echo ""
 	@echo "  dlfcn                make all in subdirectory dlfcn"
 	@echo "  doc                  make all in subdirectory doc"
 	@echo "  libcruft             make all in subdirectory libcruft"
 	@echo "  liboctave            make all in subdirectory liboctave"
 	@echo "  scripts              make all in subdirectory scripts"
 	@echo "  src                  make all in subdirectory src"
 	@echo ""
+	@echo "  configfiles          update the configuration files"
+	@echo ""
 	@echo "  help                 print this message"
 	@echo ""
 
 config-check:
 	@if test -f octMakefile; then \
 	  true; \
 	else \
 	  echo ""; \
diff --git a/configure.in b/configure.in
--- a/configure.in
+++ b/configure.in
@@ -2097,30 +2097,37 @@ typedef int sig_atomic_t;
 #define OCTAVE_EMPTY_CPP_ARG
 
 #include "oct-dlldefs.h"
 #include "oct-types.h"
 ])
 
 ### Do the substitutions in all the Makefiles.
 
+AC_CONFIG_COMMANDS([Makefile], [if test "$ac_srcdir" != "."; then
+  cp $srcdir/Makefile .
+fi])
+
+AC_SUBST(ac_config_files)
+
 AC_CONFIG_FILES([octMakefile Makeconf test/Makefile
   doc/Makefile doc/faq/Makefile doc/interpreter/Makefile
   doc/liboctave/Makefile doc/refcard/Makefile emacs/Makefile
   examples/Makefile examples/@polynomial/Makefile liboctave/Makefile
   liboctave/oct-types.h src/Makefile src/mxarray.h libcruft/Makefile
   libcruft/Makerules libcruft/amos/Makefile libcruft/blas/Makefile
   libcruft/daspk/Makefile libcruft/dasrt/Makefile
   libcruft/dassl/Makefile libcruft/fftpack/Makefile
   libcruft/lapack/Makefile 
   libcruft/misc/Makefile libcruft/odepack/Makefile
   libcruft/ordered-qz/Makefile libcruft/quadpack/Makefile
   libcruft/ranlib/Makefile libcruft/slatec-fn/Makefile
   libcruft/slatec-err/Makefile libcruft/villad/Makefile
   libcruft/blas-xtra/Makefile libcruft/lapack-xtra/Makefile])
+
 AC_OUTPUT
 
 ### Print a summary so that important information isn't missed.
 
 if test -z "$F77"; then
   FORT="$F2C $F2CFLAGS"
 else
   FORT="$F77 $FFLAGS"
diff --git a/octMakefile.in b/octMakefile.in
--- a/octMakefile.in
+++ b/octMakefile.in
@@ -66,26 +66,46 @@ CLEANSUBDIRS = $(DISTSUBDIRS)
 DIRS_TO_MAKE = $(bindir) $(datadir) $(libdir) $(octincludedir)/octave \
   $(fcnfiledir) $(localfcnfiledir) $(localapifcnfiledir) \
   $(localverfcnfiledir) $(octetcdir) $(octfiledir) $(localoctfiledir) \
   $(localapioctfiledir) $(localveroctfiledir) $(imagedir) $(archlibdir) \
   $(localarchlibdir) $(localapiarchlibdir) $(localverarchlibdir)
 
 SHELL_SCRIPTS = octave-bug octave-config mkoctfile run-octave
 
+CONFIG_FILES = @ac_config_files@
+
+M4_FILES = $(wildcard *.m4)
+
 all: $(SHELL_SCRIPTS) $(filter-out libcruft liboctave, $(SUBDIRS)) dist-info-files
 	@echo ""
 	@echo "Octave successfully built.  Now choose from the following:"
 	@echo ""
 	@echo "   ./run-octave    - to run in place to test before installing"
 	@echo "   make check      - to run the tests"
 	@echo "   make install    - to install (PREFIX=$(prefix))"
 	@echo ""
 .PHONY: all
 
+configfiles: $(CONFIG_FILES)
+	for dir in $(CONFIG_SUBDIRS); do \
+	  $(MAKE) -C $$dir configfiles; \
+	done
+.PHONY: configfiles
+
+$(CONFIG_FILES): %: %.in config.status
+	./config.status $@
+
+config.status: configure
+	./config.status --recheck
+
+configure: configure.in $(M4_FILES)
+	(cd $(top_srcdir); autoconf --force)
+	(cd $(top_srcdir); autoheader --force)
+
 src: liboctave
 
 liboctave: libcruft
 
 $(SUBDIRS):
 	$(MAKE) -C $@ all
 .PHONY: $(SUBDIRS)
 
diff --git a/scripts/ChangeLog b/scripts/ChangeLog
--- a/scripts/ChangeLog
+++ b/scripts/ChangeLog
@@ -1,8 +1,15 @@
+2009-02-08  Thorsten Meyer  <thorsten.meyier@gmx.de>
+
+	* configure.in: AC_SUBST ac_config_files
+
+	* Makefile.in:  Add make targets for configuration files
+	and config.status.
+
 2009-02-23  John W. Eaton  <jwe@octave.org>
 
 	* plot/fplot.m: Fix nargin check.
 	From Joel Parker <Joel.Parker@radiancetech.com>.
 
 2009-02-20  Steffen Groot  <steffen.groot@technolution.eu>
 
 	* plot/__patch__.m: Correct indexing of varargin.
diff --git a/scripts/Makefile.in b/scripts/Makefile.in
--- a/scripts/Makefile.in
+++ b/scripts/Makefile.in
@@ -47,19 +47,34 @@ SUBDIRS = audio deprecated elfun general
 	set signal sparse specfun special-matrix startup \
 	statistics strings testfun time
 
 DISTSUBDIRS = $(SUBDIRS)
 
 FCN_FILES = # $(wildcard $(srcdir)/*.m)
 FCN_FILES_NO_DIR = # $(notdir $(FCN_FILES))
 
+CONFIG_FILES = @ac_config_files@
+
 all: $(SUBDIRS) DOCSTRINGS
 .PHONY: all
 
+configfiles: $(CONFIG_FILES)
+.PHONY: configfiles
+
+$(CONFIG_FILES): %: %.in config.status
+	./config.status $@
+
+config.status: configure
+	./config.status --recheck
+
+configure: configure.in
+	if [ ! -f skip-autoconf ]; then autoconf --force; fi
+	if [ ! -f skip-autoheader ]; then autoheader --force; fi
+
 $(SUBDIRS):
 	$(MAKE) -C $@ all
 .PHONY: $(SUBDIRS)
 
 DOCSTRINGS: gethelp$(BUILD_EXEEXT) mkdoc $(ALL_M_FILES)
 	$(srcdir)/mkdoc $(srcdir) > $@.t
 	mv $@.t $@
 
diff --git a/scripts/configure.in b/scripts/configure.in
--- a/scripts/configure.in
+++ b/scripts/configure.in
@@ -23,16 +23,17 @@ dnl               John W. Eaton
 
 AC_INIT
 AC_REVISION()
 AC_PREREQ(2.52)
 AC_CONFIG_SRCDIR([startup/inputrc])
 
 AC_PROG_INSTALL
 
+AC_SUBST(ac_config_files)
 AC_CONFIG_FILES([Makefile audio/Makefile deprecated/Makefile elfun/Makefile \
 	  general/Makefile geometry/Makefile help/Makefile image/Makefile \
 	  io/Makefile linear-algebra/Makefile miscellaneous/Makefile \
 	  optimization/Makefile path/Makefile pkg/Makefile plot/Makefile \
 	  polynomial/Makefile set/Makefile \
 	  signal/Makefile sparse/Makefile specfun/Makefile \
 	  special-matrix/Makefile startup/Makefile statistics/Makefile \
 	  statistics/base/Makefile statistics/distributions/Makefile \
