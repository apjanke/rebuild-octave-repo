# HG changeset patch
# User jwe
# Date 1161810656 0
#      Wed Oct 25 21:10:56 2006 +0000
# Node ID ee50f74d1dd7ce6fb79b90d23388a5cd2e0fd909
# Parent  9f9313969599fcfa3cf4431d7c440f25f3c32b50
[project @ 2006-10-25 21:08:53 by jwe]

diff --git a/ChangeLog b/ChangeLog
--- a/ChangeLog
+++ b/ChangeLog
@@ -15,16 +15,21 @@ 2006-10-25  Michael Goffioul  <michael.g
 	XTRA_OCTINTERP_DEFS): Define and substitute.
 	(AH_BOTTOM) [_MSC_VER]: include definitions for CRUFT_API,
 	OCTAVE_API, and OCTINTERP_API.
 
 	* configure.in (*-*-msdosmsvc): Add "-EHs -MD" to CXXFLAGS.
 	Add "-MD" to CFLAGS.  Add "-MD" to CONFLIB_ARG when checking for
 	libf2c.
 
+	* configure.in (*-*-msdosmsvc): Generate replacement unistd.h.
+	* octMakefile.in (maintainer-clean, distclean): Also remove unistd.h.
+
+	* configure.in (*-*-msdosmsvc): Default sepchar is ';'.
+
 2006-10-25  John W. Eaton  <jwe@octave.org>
 
 	* mkoctfile.in (OCTAVE_VERSION): No need to quote replacement here.
 
 2006-10-24  John W. Eaton  <jwe@octave.org>
 
 	* run-octave.in: Only modify .gdbinit if -g option is given.
 	Use $(/bin/pwd) instead of $(pwd).
diff --git a/configure.in b/configure.in
--- a/configure.in
+++ b/configure.in
@@ -24,40 +24,56 @@ dnl Copyright (C) 1996, 1997 John W. Eat
 ### Preserve CFLAGS and CXXFLAGS from the environment before doing
 ### anything else because we don't know which macros might call
 ### AC_PROG_CC or AC_PROG_CXX.
 
 EXTERN_CFLAGS="$CFLAGS"
 EXTERN_CXXFLAGS="$CXXFLAGS"
 
 AC_INIT
-AC_REVISION($Revision: 1.530 $)
+AC_REVISION($Revision: 1.532 $)
 AC_PREREQ(2.57)
 AC_CONFIG_SRCDIR([src/octave.cc])
 AC_CONFIG_HEADER(config.h)
 
 OCTAVE_HOST_TYPE
 
 AC_DEFINE(OCTAVE_SOURCE, 1, [Define if this is Octave.])
   
+dnl FIXME -- we should probably only generate this file if it is missing.
+### Produce unistd.h for MSVC target, this simplifies changes in
+### Octave source tree and avoid problems with lex-generated code.
+case "$canonical_host_type" in
+  *-*-msdosmsvc)
+    AC_MSG_NOTICE([Generating replacement for <unistd.h> for MSVC])
+    cat << \EOF > unistd.h
+/* File generated by configure script. */
+#include <direct.h>
+#include <io.h>
+#include <process.h>
+EOF
+    CPPFLAGS="-I. $CPPFLAGS"
+    ;;
+esac
+
 AC_GNU_SOURCE
 
 AC_AIX
 AC_MINIX
 AC_ISC_POSIX
 
 ### Path separator.
 sepchar=:
 AC_ARG_WITH(sepchar,
   [AS_HELP_STRING([--with-sepchar=<char>],
      [use <char> as the path separation character])])
 case $with_sepchar in
   yes | "")
     case "$canonical_host_type" in
-      *-*-mingw*)
+      *-*-mingw* | *-*-msdosmsvc)
 	sepchar=';'
         ;;
       esac
     ;;
   no)
     AC_MSG_ERROR([You are required to define a path separation character])
     ;;
   *)
diff --git a/octMakefile.in b/octMakefile.in
--- a/octMakefile.in
+++ b/octMakefile.in
@@ -141,16 +141,17 @@ clean mostlyclean distclean maintainer-c
 	$(foreach d, $(CLEANSUBDIRS), $(do-subdir-for-command))
 .PHONY: clean mostlyclean distclean maintainer-clean
 
 maintainer-clean distclean::
 	rm -f octMakefile Makefile Makeconf Makefrag.f77 Makerules.f77
 	rm -f config.cache config.h config.log config.status
 	rm -rf autom4te.cache
 	rm -f $(SHELL_SCRIPTS) .gdbinit
+	rm -f unistd.h
 
 maintainer-clean::
 	rm -f configure config.h.in BUGS INSTALL.OCTAVE
 
 # Rules for making a source distribution.
 
 dist-info-files: INSTALL.OCTAVE BUGS
 .PHONY: dist-info-files
